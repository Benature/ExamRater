<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-table.min.css">
    <link rel="stylesheet" href="css/rotate.css">
    <!-- <link rel="stylesheet" href="css/bootstrap-editable.css"> -->
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/readcsv.js"></script>
    <!-- <script src="js/vue.min.js"></script> -->
    <script src="js/bootstrap-table.min.js"></script>
    <script src="js/bootstrap-editable.js"></script>
    <script src="js/bootstrap-table-editable.js"></script>
    <link rel="stylesheet" type="text/css" href="css/viewer.css" />
    <script type="text/javascript" src="js/viewer.js"></script>
    <meta charset="UTF-8">
    <title>é˜…å·å°åŠ©æ‰‹</title>
</head>

<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-center" style="margin-top: 30px;">
            <fieldset class="form-group col-xs-3 col-lg-offset-3">
                <input type="file" class="form-control" id="file-value">
            </fieldset>
            <button class="btn btn-success" id="upload-btn" style="margin-left:5px; height: 38px;">åŠ è½½ç­”å·å›¾ç‰‡</button>
        </div>
        <!-- <div class="row">
            <table id="test-table"></table>
        </div> -->
    </div>

    <p href="https://github.com/Benature" align="center" class="text-center">Powered by æœ¨ä¸€</p>

    <div class="d-flex flex-row justify-content-between" style="width:100%">
        <div id="img-container" style="width:80%; height: 50rem;">
            <img src="intro.png" id="img" style="z-index: -10;width:40px">
        </div>
        <div style="width:12rem; margin: 40px 10px;">
            <div class="d-flex justify-content-between flex-wrap">
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="rotate1">é¡ºæ—‹ ğŸ”ƒ</button>
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="rotate2">é€†æ—‹ ğŸ”„</button>
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="big">æ”¾å¤§</button>
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="small">ç¼©å°</button>
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="rotate0">é‡ç½®</button>
            </div>
            <br />
            <!-- <form> -->
            <p id="warning" style="color:red"></p>
            <br />
            <div class="d-flex">
                <button class="btn btn-secondary" style="margin-bottom:4px;" id="jump_prev">ä¸Šä¸€å¼ </button>
                <button class="btn btn-secondary" style="margin-bottom:4px; margin-left:10px"
                    id="jump_next">ä¸‹ä¸€å¼ </button>
            </div>
            <a id="info"></a>
            <div class="d-flex flex-row">
                <input type="value" id="value" class="form-control" style="width:4rem">
                <button class="btn btn-primary" id="next" style="margin-left:5px;">åˆ¤åˆ†</button>
            </div>
            <br />
            <div class="d-flex flex-row">
                <input type="value" id="jumpIndex" class="form-control" style="width:3rem;">
                <button class="btn btn-secondary" id="jump" style="margin-left:5px;">è·³è½¬</button>
            </div>
            <p></p>
            <br />
            <div class="d-flex justify-content-center">
                <button class="btn btn-success" id="save" style="width:6rem">ä¿å­˜</button>
            </div>
            <!-- <input value="é˜…å·"> -->
            <!-- </form> -->
        </div>
    </div>
</body>
<script>
    var data;
    var index = 0;
    var WIDTH;
    var img = document.getElementById('img');
    var w, h;
    // var viewer;
    var viewer = new Viewer(document.getElementById('img'), {
        inline: true,
        toolbar: false,
        navbar: false,
    });
    viewer.show()

    /*
     * Render image 
    */
    function render() {
        console.log(data[index])

        // if (index != 0) {
        viewer.destroy()
        // }
        $('#img').attr('src', data[index][2]);
        viewer = new Viewer(document.getElementById('img'), {
            inline: true,
            zIndex: -10,
            navbar: false,
            toolbar: {
                zoomIn: true,
                zoomOut: true,
                oneToOne: true,
                reset: true,
                prev: false,
                play: {
                    show: false,
                    size: 'large',
                },
                next: false,
                rotateLeft: {
                    show: true,
                    size: 'large',
                },
                rotateRight: {
                    show: true,
                    size: 'large',
                },
                flipHorizontal: false,
                flipVertical: false,
            },
            // viewed() {
            //     viewer.zoomTo(1);
            // },
        });
        // Then, show the image by click it, or call `viewer.show()`.
        viewer.show()
        // $('.viewer-move.viewer-transition').attr('src', data[index][2]);
        console.log(data[index])
        // $("#rotate0").click();
        $('#info').text(data[index].join("  "))

    }

    $("#upload-btn").click(function () {
        var files = document.getElementById("file-value").files;
        data = readParseFiles(files, "utf-8", function (d) {
            data = d[0];
            console.log(data);
            data.sort(function (a, b) {
                return a[0] - b[0];
            })
            $('.container-fluid').addClass('d-none')
            render();
        });
    })

    $("#next").click(function () {
        let v = $('#value').val()
        data[index][3] = v;
        index++;
        if (index >= data.length) {
            $('#warning').text('æ”¹å®Œå•¦ï¼')
            $("#save").click();
        } else {
            // console.log(v);
            console.log(data)
            render();
            $("#rotate0").click();
        }
        $('#value').val('')
    })

    $("#jump").click(function () {
        let v = $('#jumpIndex').val()
        index = parseInt(v);
        render();
    })
    $("#save").click(function () {
        var lineArray = [];
        data.forEach(function (infoArray, index) {
            var line = infoArray.join(",");
            lineArray.push(line);
        });
        var csvContent = lineArray.join("\n");
        console.log(csvContent)


        var a = document.createElement('a');
        var blob = new Blob([csvContent], { 'type': 'application\/octet-stream' });
        a.href = window.URL.createObjectURL(blob);
        a.download = 'é˜…å·æˆç»©.csv';
        a.click()

    })

    $('#value').keyup(function (e) {
        if (13 == e.keyCode) {
            $('#next').click();
        }
    })
    $("#rotate0").click(function () { viewer.rotateTo(0); })
    $("#rotate1").click(function () { viewer.rotate(90); })
    $("#rotate2").click(function () { viewer.rotate(-90); })
    $("#big").click(function () { viewer.zoom(0.2); })
    $("#small").click(function () { viewer.zoom(-0.2); })
    $("#jump_prev").click(function () { index--; render(); })
    $("#jump_next").click(function () { index++; render(); })
    $(document).keyup(function (e) {
        console.log(e.keyCode);
        if (82 == e.keyCode && !e.shiftKey) {
            $("#rotate0").click();
        }
    });
    $("#rotate0").click();
</script>

</html>